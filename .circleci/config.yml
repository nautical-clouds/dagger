version: 2.1

orbs:
  aws-cli: circleci/aws-cli@volatile
  kubernetes: circleci/kubernetes@1.3.1

jobs:
  cp_build:
    docker:
      - image: cimg/base:2021.11
    resource_class: nautical-clouds/container
    steps:
     - checkout
     - aws-cli/setup:
         profile_name: default
     - kubernetes/install-kubectl
     - run:
         name: Install Dagger CLI
         command: curl -fsSL https://dl.dagger.io/dagger/install.sh | BIN_DIR=$HOME/.local/bin sh
     - run:
         name: k8s dagger pods
         command: |
                  aws configure set profile.default.aws_access_key_id "$AWS_ACCESS_KEY_ID" 
                  aws configure set profile.default.aws_secret_access_key "$AWS_SECRET_ACCESS_KEY>" 
                  aws configure set profile.default.region us-east-1
                  aws configure list --profile default
                  aws eks --region us-east-1 update-kubeconfig --name releng-eks-circleci

                  kubectl get pods --all-namespaces
                   
                  DAGGER_ENGINE_POD_NAME="$(kubectl get pod \
                  --selector=name=dagger-dagger-helm-engine --namespace=dagger \
                  --output=jsonpath='{.items[0].metadata.name}')"
                  export DAGGER_ENGINE_POD_NAME

                  _EXPERIMENTAL_DAGGER_RUNNER_HOST="kube-pod://$DAGGER_ENGINE_POD_NAME?namespace=dagger"
                  export _EXPERIMENTAL_DAGGER_RUNNER_HOST

                  dagger query \<<EOF
                  {
                      container {
                          from(address:"alpine") {
                              withExec(args: ["uname", "-a"]) { stdout }
                          }
                      }
                  }
                  EOF

     - run: dagger core container from --address "alpine" with-exec --args "echo,hi" 

workflows:
  cp_build:
    jobs:
      - cp_build:
          context: cloud-global